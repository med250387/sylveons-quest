<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Sylveons Quest</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#ffd0ea; }
    /* make the canvas fill the screen */
    #game { width:100vw; height:100vh; display:block; touch-action: manipulation; }

    .btnbar { position: fixed; top: 8px; right: 8px; z-index: 5; display:flex; gap:8px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .btnbar button { padding:8px 10px; border-radius:12px; border:none; background:#ffffffcc; backdrop-filter: blur(6px); font-weight:700; cursor:pointer; }
    .btnbar button:active { transform: translateY(1px); }
    .badge { position: fixed; left: 8px; top: 8px; z-index: 5; background:#ffffffcc; padding:6px 10px; border-radius:12px; font: 14px/1.2 ui-sans-serif, system-ui; }
    .credits { position: fixed; bottom: 8px; right: 8px; z-index: 5; font: 12px/1.2 ui-sans-serif, system-ui;
      color:#000000aa; background:#ffffff88; padding:6px 8px; border-radius:8px; }

    .screen { position: fixed; inset: 0; display: none; z-index: 999; align-items: center; justify-content: center; flex-direction: column; }
    #startScreen { display: flex; background: #07A0FF; color: white; text-align: center; }
    #startTitle { font-family: "Comic Sans MS", "Baloo 2", "Fredoka", system-ui, -apple-system, sans-serif;
      font-size: clamp(40px, 10vw, 120px); line-height: 1; color: #ff87c9; margin: 0 12px 18px;
      text-shadow: 0 0 8px rgba(255,255,255,0.9), 2px 2px 0 #ffffff, -2px -2px 0 #ffffff,
                   4px 4px 0 rgba(0,0,0,0.08), 0 0 20px rgba(255,255,255,0.9); letter-spacing: 2px; }
    .yellowBtn { background: #ffd84d; color: #3a2a00; border: none; border-radius: 16px;
      padding: 14px 22px; font-size: clamp(18px, 3.5vw, 22px); font-weight: 800; cursor: pointer; margin: 8px;
      box-shadow: 0 6px 0 #c7a92f, 0 10px 18px rgba(0,0,0,0.15); }
    .yellowBtn:active { transform: translateY(2px); box-shadow: 0 4px 0 #c7a92f; }

    #overScreen { background: rgba(255, 208, 234, 0.96); color: #ff87c9; text-align: center; }
    #overTitle { font-family: "Comic Sans MS", "Baloo 2", "Fredoka", system-ui, -apple-system, sans-serif;
      font-size: clamp(36px, 8vw, 96px); line-height: 1.1; color: #ff87c9; margin: 0 12px 18px;
      text-shadow: 0 0 8px rgba(255,255,255,0.9), 2px 2px 0 #ffffff, -2px -2px 0 #ffffff,
                   4px 4px 0 rgba(0,0,0,0.08), 0 0 20px rgba(255,255,255,0.9); }
    #tryBtn { margin-top: 10px; }

    /* Version tag on start screen */
    #versionTag { margin-top: 12px; font: 12px/1.2 ui-sans-serif, system-ui; color:#fff;
      background:#00000033; padding:6px 8px; border-radius:8px; }

    /* Debug panel */
    #debug {
      position: fixed; top: 8px; left: 8px; z-index: 1200;
      width: min(90vw, 520px); max-height: 48vh; overflow:auto;
      background: #fff6fa; color:#6a0030; border:1px solid #ffa6c9; border-radius:10px;
      padding:8px 10px; font: 12px/1.35 ui-sans-serif, system-ui; white-space: pre-wrap;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      display: none;
    }
    #debug b { color:#a3003d; }
  </style>
</head>
<body>
  <!-- Start Screen -->
  <section id="startScreen" class="screen">
    <h1 id="startTitle">Sylveons Quest</h1>
    <div>
      <button id="startKid" class="yellowBtn">Kid Mode</button>
      <button id="startStd" class="yellowBtn">Standard Mode</button>
    </div>
    <p style="margin-top:10px;font:14px/1.2 ui-sans-serif,system-ui;">
      If nothing happens, hard-refresh (⌘⇧R). On iPad: hold reload → “Reload Without Content Blockers”.
    </p>
    <div id="versionTag">Version v1.0.6</div>
  </section>

  <!-- Game Over Screen -->
  <section id="overScreen" class="screen">
    <h2 id="overTitle">Try again?</h2>
    <button id="tryBtn" class="yellowBtn">Tap to Restart</button>
  </section>

  <div id="debug"></div>

  <div class="badge">Sylveon Sky Run • Tap: Jump • Swipe: Left/Right</div>
  <div class="btnbar">
    <button id="btnKid">Kid Mode: OFF</button>
    <button id="btnMute">Mute</button>
    <button id="btnPause">Pause</button>
    <button id="btnFS">Full screen</button>
  </div>

  <!-- IMPORTANT: this is now a CANVAS, not a DIV -->
  <canvas id="game"></canvas>

  <div class="credits">Works offline after first load</div>

  <!-- Local engine (no CDNs) -->
  <script src="assets/kaboom.js"></script>

  <!-- Full Game with diagnostics -->
  <script>
    // ===== Debug helpers =====
    const $ = (id)=>document.getElementById(id);
    const dbgBox = $('debug');
    function dbg(msg){ dbgBox.style.display='block'; dbgBox.textContent += (msg + "\\n"); console.log(msg); }
    window.addEventListener('error', (e)=>{ dbg("JS Error: " + e.message + " @ " + (e.filename||'') + ":" + (e.lineno||'?')); });

    // Startup logs
    dbg("Booting Sylveons Quest (v1.0.6)...");
    dbg("Checking engine: " + (typeof window.kaboom));

    // Button wiring BEFORE game init (so we can see clicks even if init fails)
    $('startKid').addEventListener('click', ()=>{ dbg("UI: Kid Mode clicked"); safeStart(true); });
    $('startStd').addEventListener('click', ()=>{ dbg("UI: Standard Mode clicked"); safeStart(false); });
    $('tryBtn').addEventListener('click', ()=>{ $('startScreen').style.display='flex'; $('overScreen').style.display='none'; });

    function safeStart(startKid){
      try {
        if (typeof window.kaboom !== 'function') {
          dbg("Engine missing. Check that assets/kaboom.js exists (case-sensitive) and is being served.");
          alert("Game engine not found. Please confirm assets/kaboom.js exists in your repo.");
          return;
        }
        startGame(startKid);
      } catch (err) {
        dbg("startGame crashed: " + err.message);
      }
    }

    // ===== Full Game =====
    function startGame(startKid){
      dbg("startGame() entered — kid=" + !!startKid);

      const THEME={heroName:"Sylveon",collectNameSingular:"Munna",collectNamePlural:"Munnas",
        skyTop:[255,208,234],skyBottom:[255,238,250],cloudColor:[255,255,255],
        hedgePink:[255,169,214],heroFallback:[255,182,238],munnaFallback:[255,163,213]};
      const SPEEDS={normalStart:280,kidStart:230,minuteRamp:60};

      // kaboom init — now targeting the <canvas id="game">
      const k=kaboom({
        background:THEME.skyBottom,
        touchToMouse:true,
        global:true,
        width:Math.min(window.innerWidth,1920),
        height:Math.min(window.innerHeight,1080),
        canvas:document.getElementById("game"),
        scale:1
      });
      dbg("Kaboom initialised ✔︎");

      // DOM refs
      const startScreen=$('startScreen');
      const overScreen=$('overScreen');

      // state
      let kidMode=!!startKid,worldSpeed=kidMode?SPEEDS.kidStart:SPEEDS.normalStart;
      let minuteTimer=0,shield=1,gameActive=false;

      // screen flows
      function showStart(){ gameActive=false; startScreen.style.display="flex"; overScreen.style.display="none"; }
      function showOver(){ gameActive=false; overScreen.style.display="flex"; }
      function begin(){ restartGame(); startScreen.style.display="none"; gameActive=true; }
      document.getElementById("btnKid").textContent=`Kid Mode: ${kidMode?"ON":"OFF"}`;
      begin();

      // physics
      setGravity(2000);
      const GROUND_Y=height()-80;

      // cloud drawing
      function drawCloudBlob(s=1){
        drawCircle(vec2(-40,-6),30*s, rgb(...THEME.cloudColor));
        drawCircle(vec2(-10,-18),38*s,rgb(...THEME.cloudColor));
        drawCircle(vec2(28,-8),32*s,rgb(...THEME.cloudColor));
        drawCircle(vec2(56,-14),24*s,rgb(...THEME.cloudColor));
      }
      function makeCloudGround(x){
        return add([ pos(x,GROUND_Y),
          { draw(){
              pushTransform(); translate(this.pos);
              drawRect({width:width(),height:40,pos:vec2(0,0),color:rgb(255,255,255)});
              for(let i=0;i<Math.ceil(width()/80);i++){
                pushTransform(); translate(vec2(i*80+20,-6)); drawCloudBlob(1); popTransform();
              }
              popTransform();
            } },
          area({shape:new Rect(vec2(0,0),width(),40)}),
          move(LEFT,worldSpeed),
          "ground" ]);
      }
      let groundA=makeCloudGround(0), groundB=makeCloudGround(width());
      loop(1,()=>{ if(gameActive) add([ pos(width()+60,rand(20,height()*0.6)),
        { draw(){ pushTransform(); translate(this.pos); scaleTo(vec2(rand(0.7,1.8))); drawCloudBlob(1); popTransform(); } },
        move(LEFT,rand(18,50)), "cloud" ]); });

      // assets: load & upgrade
      let heroSpriteReady=false, munnaSpriteReady=false, hedgeSpriteReady=false;
      loadSprite("hero","assets/hero.png").then(()=>{ heroSpriteReady=true; if (hero.exists()) hero.use(sprite("hero",{width:60,height:48})); }).catch(()=>{});
      loadSprite("munna","assets/munna.png").then(()=>{ munnaSpriteReady=true; }).catch(()=>{});
      loadSprite("hedge","assets/hedge.png").then(()=>{ hedgeSpriteReady=true; }).catch(()=>{});

      // hero
      const hero=add([
        pos(160,0), area(), body(), anchor("center"), "hero",
        { jumpForce:760, canDouble:false, vx:0, maxVX:360, invuln:0 }
      ]);
      hero.use(rect(54,34));
      hero.use(color(...THEME.heroFallback));
      if (heroSpriteReady) hero.use(sprite("hero",{width:60,height:48}));
      hero.onGround(()=>hero.canDouble=true);

      function doJump(){
        if(!gameActive) return;
        if(hero.isGrounded()){ hero.jump(hero.jumpForce); hero.canDouble=true; }
        else if(hero.canDouble){ hero.jump(hero.jumpForce*0.9); hero.canDouble=false; }
      }
      onClick(()=>doJump());

      // spawns
      function spawnHedge(){
        const fly=chance(0.45);
        const w=rand(36,64), h=rand(28,48);
        const y=fly?rand(GROUND_Y-250,GROUND_Y-120):(GROUND_Y-h);
        const o=add([ pos(width()+rand(0,120),y), area(), move(LEFT,worldSpeed), "obstacle" ]);
        if (hedgeSpriteReady) o.use(sprite("hedge",{width:w,height:h}));
        else { o.use(rect(w,h)); o.use(color(...THEME.hedgePink)); }
      }
      function spawnMunna(){
        const y=rand(GROUND_Y-260,GROUND_Y-90);
        const r=rand(14,kidMode?22:18);
        const c=add([ pos(width()+rand(0,60), y), area({shape:new Circle(vec2(0,0), r)}), move(LEFT,worldSpeed*1.05), "collectible" ]);
        if (munnaSpriteReady) c.use(sprite("munna",{width:r*2.4,height:r*2.2}));
        else { c.use(circle(r)); c.use(color(...THEME.munnaFallback)); }
      }
      loop(1,()=>{ if(gameActive){ if(chance(kidMode?0.55:0.7)) spawnHedge(); if(chance(kidMode?0.75:0.6)) spawnMunna(); } });

      // score
      let meters=0,saved=0;
      const meterLabel=add([text("",{size:30}),pos(16,16),fixed()]);
      const savedLabel=add([text("",{size:30}),pos(16,50),fixed()]);
      function updateUI(){ meterLabel.text=`Distance: ${meters.toFixed(1)} m`; savedLabel.text=`Munnas: ${saved}`; }
      loop(1,()=>{ if(gameActive){ meters+=worldSpeed/60; minuteTimer++; if(!kidMode && minuteTimer%60===0) worldSpeed+=SPEEDS.minuteRamp; updateUI(); } });

      // update + failcheck
      onUpdate(()=>{
        [groundA,groundB].forEach(g=>g.move(LEFT,gameActive?worldSpeed:0));
        if(groundA.pos.x + width() < 0) groundA.pos.x = groundB.pos.x + width();
        if(groundB.pos.x + width() < 0) groundB.pos.x = groundA.pos.x + width();
        hero.pos.x = clamp(hero.pos.x + hero.vx * dt(), 60, width()*0.75);
        hero.vx *= 0.9;
        if(gameActive && hero.pos.y > height()+60) hitObstacle();
      });

      // collisions
      hero.onCollide("obstacle",()=>{ if(gameActive) hitObstacle(); });
      hero.onCollide("collectible",c=>{ if(!gameActive) return; destroy(c); saved++; updateUI(); });

      // one free hit
      function hitObstacle(){
        if(hero.invuln>0) return;
        if(shield>0){
          shield--; hero.invuln=1.5; updateUI();
          wait(1.5,()=>{ hero.invuln=0; });
        } else { gameOver(); }
      }
      function gameOver(){ gameActive=false; showOver(); }

      // reset
      function restartGame(){
        destroyAll("obstacle"); destroyAll("collectible"); destroyAll("cloud");
        meters=0; saved=0; minuteTimer=0;
        worldSpeed = kidMode ? SPEEDS.kidStart : SPEEDS.normalStart;
        shield=1; hero.invuln=0;
        hero.pos=vec2(160,0); hero.vel=vec2(0,0); hero.vx=0; hero.canDouble=false;
      }

      // top-right controls
      document.getElementById("btnKid").onclick=()=>{ kidMode=!kidMode; document.getElementById("btnKid").textContent=`Kid Mode: ${kidMode?"ON":"OFF"}`; worldSpeed = kidMode ? SPEEDS.kidStart : SPEEDS.normalStart; };
      document.getElementById("btnPause").onclick=()=>{ gameActive=!gameActive; };
      document.getElementById("btnFS").onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };

      dbg("Game started ✔︎");
    }
  </script>
</body>
</html>
